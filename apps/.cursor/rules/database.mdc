---
description: Database and ORM rules for Drizzle ORM and SQLite3
globs: **/*.ts
alwaysApply: false 
---

# Database & ORM Rules

## Drizzle ORM Patterns

### Schema Definition

```typescript
import { sqliteTable, text, integer } from 'drizzle-orm/sqlite-core';
import { sql } from 'drizzle-orm';

export const event = sqliteTable('event', {
  id: text('id').primaryKey().unique().notNull(),
  church_id: text('church_id').references(() => church.id, { onDelete: 'cascade' }).notNull(),
  date: text('date').notNull(),
  week_number: integer('week_number'),
  created_at: integer('created_at').default(sql`(unixepoch())`),
  active: integer('active').notNull().default(1)
});
```

### Type-Safe Queries

Always use Drizzle's type-safe query builder:

```typescript
import { eq, and, inArray } from 'drizzle-orm';

export async function findEventById(db: ReturnType<typeof drizzle>, id: string): Promise<ChurchEvent | null> {
  const result = await db.select().from(event).where(eq(event.id, id)).limit(1);
  return result[0] ? mapToChurchEvent(result[0]) : null;
}

// âŒ Bad: Raw SQL
const query = `SELECT * FROM event WHERE id = ${id}`;
```

### Query Patterns

```typescript
const conditions = [
  eq(event.church_id, churchId),
  inArray(event.week_number, weekNumbers),
  eq(event.active, 1)
];

const results = await db
  .select()
  .from(event)
  .where(and(...conditions))
  .orderBy(desc(event.date))
  .limit(limit);
```

### Insert/Update/Delete

```typescript
// Insert with returning
const result = await db.insert(event).values({ ...data }).returning();

// Update with where clause
const result = await db.update(event).set({ ...data }).where(eq(event.id, id)).returning();

// Soft delete
await db.update(event).set({ active: 0 }).where(eq(event.id, id));
```

### Transactions

```typescript
await db.transaction(async (tx) => {
  const createdEvent = await createEvent(tx, event);
  await persistEventUshers(tx, createdEvent.id, ushers);
});
```

## Repository Pattern

### Interface (core/repositories/)

```typescript
export interface ScheduleRepository {
  getEventById(id: string): Promise<ChurchEvent>;
  insertEvent(event: ChurchEvent): Promise<ChurchEvent>;
  listEventsByWeekNumber(churchId: string, weekNumbers: number[], isToday: boolean, limit?: number): Promise<ChurchEvent[]>;
}
```

### Adapter (lib/server/adapters/)

```typescript
export class SQLiteAdapter implements ScheduleRepository {
  private db: ReturnType<typeof drizzle>;
  getEventById = (id: string) => findEventById(this.db, id);
  insertEvent = (event: ChurchEvent) => createEvent(this.db, event);
}
```

## Migrations

1. Update schema in `src/lib/server/db/schema.ts`
2. Generate: `npm run db:generate`
3. Apply: `npm run db:migrate`

Never edit migration files manually.

## Performance

- Add indexes for frequently queried columns
- Use `limit()` to restrict result sets
- Use transactions for multiple related operations

## Type Inference

```typescript
import { event } from '$lib/server/db/schema';
type EventRow = typeof event.$inferSelect;
type EventInsert = typeof event.$inferInsert;
```
