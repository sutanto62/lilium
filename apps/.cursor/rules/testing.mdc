---
description: Testing rules and patterns for Vitest and Playwright
globs: **/*.test.ts,**/*.spec.ts
alwaysApply: false 
---

# Testing Rules

## Test File Naming

- Unit tests: `*.test.ts` (e.g., `EventService.test.ts`)
- Integration tests: `*.test.ts` in appropriate directories

## Test Structure

Organize tests using `describe` blocks:

```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest';

describe('EventService', () => {
  let eventService: EventService;
  const mockChurchId = 'church-1';

  beforeEach(() => {
    eventService = new EventService(mockChurchId);
    vi.clearAllMocks();
  });

  describe('retrieveEventById', () => {
    it('should return event by id', async () => {
      // Test implementation
    });
  });
});
```

## Mocking Patterns

### Mock External Dependencies

```typescript
import { vi } from 'vitest';

vi.mock('$src/lib/server/db', () => ({
  repo: {
    getEventById: vi.fn(),
    insertEvent: vi.fn()
  }
}));

import { repo } from '$src/lib/server/db';

it('should retrieve event by id', async () => {
  const mockEvent: ChurchEvent = {
    id: '1',
    church: 'church-1',
    mass: 'mass-1',
    date: '2024-03-20'
  };

  vi.mocked(repo.getEventById).mockResolvedValue(mockEvent);
  const result = await eventService.retrieveEventById('1');

  expect(repo.getEventById).toHaveBeenCalledWith('1');
  expect(result).toEqual(mockEvent);
});
```

## Test Assertions

```typescript
it('should return events for specified week numbers', async () => {
  vi.mocked(repo.listEventsByWeekNumber).mockResolvedValue(mockEvents);
  const result = await eventService.retrieveEventsByWeekRange({ weekNumber: 12 });

  expect(repo.listEventsByWeekNumber).toHaveBeenCalledWith(mockChurchId, [12, 13], false, undefined);
  expect(result).toEqual(mockEvents);
  expect(result).toHaveLength(1);
});
```

### Error Testing

```typescript
it('should throw validation error when church ID is missing', async () => {
  await expect(eventService.createEvent({ mass: 'mass-1', date: '2024-03-20' }))
    .rejects.toThrow('Church ID is required');
  expect(repo.insertEvent).not.toHaveBeenCalled();
});
```

## Test Data

Use test data factories:

```typescript
function createMockEvent(overrides?: Partial<ChurchEvent>): ChurchEvent {
  return {
    id: '1',
    church: 'church-1',
    mass: 'mass-1',
    date: '2024-03-20',
    weekNumber: 12,
    createdAt: 1710892800000,
    active: 1,
    ...overrides
  };
}
```

## Integration Tests

### Playwright Patterns

```typescript
import { test, expect } from '@playwright/test';

test.describe('Event Management', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/admin/misa');
  });

  test('should display events list', async ({ page }) => {
    await expect(page.locator('h1')).toContainText('Misa');
    await expect(page.locator('table')).toBeVisible();
  });
});
```

## Test Coverage

- Aim for high coverage of business logic (services, utilities)
- Focus on critical paths and error cases
- Don't test implementation details, test behavior
- Use `npm run test:coverage` to check coverage

## Async Testing

Always await async operations:

```typescript
// ✅ Good
it('should retrieve events asynchronously', async () => {
  const result = await eventService.retrieveEventsByWeekRange({ weekNumber: 12 });
  expect(result).toBeDefined();
});

// ❌ Bad
it('should retrieve events', () => {
  const result = eventService.retrieveEventsByWeekRange({ weekNumber: 12 });
  expect(result).toBeDefined(); // This will fail
});
```

## Test Isolation

- Each test should be independent
- Use `beforeEach` to set up test state
- Use `vi.clearAllMocks()` to reset mocks
- Don't rely on test execution order
