---
description: Web security guidelines covering authentication, authorization, input validation, secrets management, HTTP headers, and security best practices
globs: **/*.ts,**/*.svelte
alwaysApply: false 
---

# Web Security Rules

## Authentication & Authorization

### Session Management

Always validate sessions before accessing protected resources:

```typescript
export const load: LayoutServerLoad = async (event) => {
  const session = await event.locals.auth();
  if (!session) throw redirect(302, '/signin');
  if (session.user?.unregistered) throw redirect(302, '/');
  return { session };
};
```

### Role-Based Access Control

Use `hasRole()` for authorization checks:

```typescript
import { hasRole } from '$src/auth';

export const load: LayoutServerLoad = async (event) => {
  const session = await event.locals.auth();
  if (!session || !hasRole(session, 'admin')) {
    throw redirect(302, '/signin');
  }
  return { session };
};

// In form actions
export const actions: Actions = {
  default: async ({ request, locals }: RequestEvent) => {
    const session = await locals.auth();
    if (!hasRole(session, 'admin')) {
      return fail(403, { error: 'Anda tidak memiliki izin untuk melakukan aksi ini' });
    }
    // ... action logic
  }
};
```

### Public Routes

Public routes (`/f/*`, `/lingkungan`) still require input validation:

```typescript
export const actions = {
  default: async ({ request }) => {
    const eventId = formData.get('eventId') as string;
    if (!eventId || typeof eventId !== 'string') {
      return fail(400, { error: 'Invalid event ID' });
    }
    // ... process
  }
};
```

## Environment Variables & Secrets

### VITE_ Prefix Security

**CRITICAL**: `VITE_` prefixed variables are exposed to client. Never store secrets in `VITE_` variables.

```typescript
// ❌ Bad: Secrets exposed to client
const secret = import.meta.env.VITE_AUTH_SECRET;

// ✅ Good: Only non-sensitive config in VITE_
const clientId = import.meta.env.VITE_GOOGLE_CLIENT_ID; // OK - public

// ✅ Good: Server-only secrets (use process.env, no VITE_ prefix)
const authSecret = process.env.AUTH_SECRET; // Server-only
```

### Migration from VITE_ to Server-Only

1. Remove `VITE_` prefix from environment variable name
2. Update code to use `process.env` instead of `import.meta.env`
3. Ensure code runs only on server (`.server.ts` files)

### Environment Variable Validation

```typescript
const authSecret = process.env.AUTH_SECRET;
if (!authSecret || authSecret.length < 32) {
  throw new Error('AUTH_SECRET must be at least 32 characters');
}
```

## Input Validation & Sanitization

### Form Data Validation

Always validate and sanitize form inputs:

```typescript
export const actions: Actions = {
  default: async ({ request }) => {
    const formData = await request.formData();
    const date = formData.get('date') as string;
    const code = formData.get('code') as string;

    if (!date) return fail(400, { error: 'Tanggal harus diisi' });
    const dateObj = new Date(date);
    if (isNaN(dateObj.getTime())) return fail(400, { error: 'Tanggal tidak valid' });

    if (!code || code.trim().length === 0) return fail(400, { error: 'Kode harus diisi' });
    // ... process validated data
  }
};
```

### Type Validation and Coercion

```typescript
const eventId = formData.get('eventId');
if (!eventId || typeof eventId !== 'string') {
  return fail(400, { error: 'Invalid event ID' });
}

const weekNumber = formData.get('weekNumber');
const weekNumberNum = weekNumber ? Number(weekNumber) : null;
if (weekNumberNum !== null && isNaN(weekNumberNum)) {
  return fail(400, { error: 'Week number must be a valid number' });
}
```

### XSS Prevention

Svelte automatically escapes content. Use `{@html}` only with sanitized content:

```svelte
<!-- ✅ Good: Automatic escaping -->
<p>{userInput}</p>

<!-- ✅ Good: Sanitized HTML -->
{@html sanitizeHtml(userInput)}

<!-- ❌ Bad: Unsanitized HTML -->
{@html userInput}
```

## HTTP Security Headers

Implement security headers in `src/hooks.server.ts`:

```typescript
const securityHeaders: Handle = async ({ event, resolve }) => {
  const response = await resolve(event);
  
  response.headers.set('Content-Security-Policy',
    "default-src 'self'; script-src 'self' 'unsafe-inline' https://statsig.com https://app.posthog.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://statsig.com https://app.posthog.com; frame-ancestors 'none';"
  );
  response.headers.set('X-Frame-Options', 'DENY');
  response.headers.set('X-Content-Type-Options', 'nosniff');
  response.headers.set('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');
  
  return response;
};

export const handle = sequence(authHandle, securityHeaders);
```

## CSRF Protection

SvelteKit provides built-in CSRF protection for form actions. Always use SvelteKit form actions:

```typescript
// ✅ Good: SvelteKit form actions (CSRF protected)
export const actions: Actions = {
  default: async ({ request, locals }) => {
    const session = await locals.auth();
    // ... action logic
  }
};

// ❌ Bad: Direct fetch (bypasses CSRF protection)
async function submitForm() {
  await fetch('/api/endpoint', { method: 'POST', body: JSON.stringify(formData) });
}
```

## Session & Cookie Security

```typescript
cookies.set('cid', churchConfigured.id, {
  path: '/',
  httpOnly: true,
  sameSite: 'strict',
  secure: true,
  maxAge: 60 * 60 * 24 * 30
});
```

## Error Handling Security

Never expose sensitive information in error messages:

```typescript
// ✅ Good: Sanitized error messages
try {
  const result = await db.select().from(event).where(eq(event.id, eventId));
  if (!result[0]) throw ServiceError.notFound('Event not found', { id: eventId });
} catch (error) {
  if (error instanceof ServiceError) {
    return fail(404, { error: 'Event tidak ditemukan' });
  }
  logger.error('EventService.retrieveEventById: Unexpected error', { error, eventId });
  return fail(500, { error: 'Terjadi kesalahan saat mengambil data' });
}

// ❌ Bad: Exposing sensitive information
catch (error) {
  return fail(500, { 
    error: `Database error: ${error.message}`,
    stack: error.stack
  });
}
```

### Logging Sensitive Data

```typescript
// ✅ Good: Safe error logging
logger.error('EventService.createEvent: Failed', {
  eventId: newEvent.id, // OK - public identifier
  error: error instanceof Error ? error.message : 'Unknown error'
  // Don't log: passwords, tokens, full user objects
});

// ❌ Bad: Logging sensitive data
logger.error('Auth failed', {
  password: userPassword, // NEVER log passwords
  token: authToken // NEVER log tokens
});
```

### Stack Trace Exposure

```typescript
import { dev } from '$app/environment';

catch (error) {
  logger.error('Error details', { error, context });
  if (dev) {
    return fail(500, { error: error.message, stack: error.stack });
  }
  return fail(500, { error: 'Terjadi kesalahan. Silakan coba lagi.' });
}
```

## Database Security

Always use Drizzle ORM's parameterized queries (see `.cursor/rules/database.mdc`):

```typescript
// ✅ Good: Parameterized queries
const result = await db.select().from(event).where(eq(event.id, eventId)).limit(1);

// ❌ Bad: Raw SQL (NEVER use this)
const query = `SELECT * FROM event WHERE id = '${eventId}'`;
```

## API Security

### Rate Limiting

Consider implementing rate limiting for public endpoints:

```typescript
const rateLimiter = new Map<string, { count: number; resetAt: number }>();

function checkRateLimit(ip: string, limit: number = 100, windowMs: number = 60000): boolean {
  const now = Date.now();
  const record = rateLimiter.get(ip);
  if (!record || now > record.resetAt) {
    rateLimiter.set(ip, { count: 1, resetAt: now + windowMs });
    return true;
  }
  if (record.count >= limit) return false;
  record.count++;
  return true;
}
```

### Request Validation

Always validate API request inputs:

```typescript
const eventId = formData.get('eventId') as string;
if (!eventId || typeof eventId !== 'string' || eventId.length === 0) {
  return fail(400, { error: 'Invalid event ID' });
}
```

## Dependency Security

- Regularly scan: `npm audit`
- Keep dependencies up to date: `npm outdated`
- Commit `package-lock.json` to version control
- Never modify `package-lock.json` manually

## Security Checklist

- [ ] All authentication checks in place
- [ ] Authorization enforced on protected routes
- [ ] Input validation for all user inputs
- [ ] No secrets in `VITE_` prefixed variables
- [ ] HTTP security headers configured
- [ ] Cookies have secure attributes
- [ ] Error messages don't expose sensitive information
- [ ] Database queries use parameterized queries
- [ ] Dependencies up to date
- [ ] Stack traces not exposed in production
