---
description: Analytics event tracking guidelines using Statsig and PostHog
globs: **/*.ts,**/*.svelte
alwaysApply: false 
---

# Event Tracking Rules

## Dual Tracking Strategy

- **Statsig**: Server-side events, key business events, error tracking
- **PostHog**: Client-side business events, user interactions, empty states
- **PostHog Autocapture**: Automatically tracks clicks and pageviews - leverage this instead of manual tracking

```typescript
// ✅ Good: Server-side dual tracking
await Promise.all([
  statsigService.logEvent('admin_jadwal_view', 'load', session || undefined, metadata),
  posthogService.trackEvent('admin_jadwal_view', { event_type: 'page_load', ...metadata }, session || undefined)
]);

// ✅ Good: Client-side Statsig for key events
statsigService.logEvent('admin_jadwal_filter', 'change', page.data.session || undefined, metadata);

// ✅ Good: Client-side PostHog for business context
await tracker.track('admin_jadwal_filter_change', metadata, page.data.session, page);
```

## Event Naming

Follow pattern: `{page}_{action}_{context}` using **snake_case**

```typescript
// ✅ Good
'admin_jadwal_view'
'admin_jadwal_filter_change'
'admin_jadwal_event_navigate'

// ❌ Bad
'jadwal_view'  // Missing context
'filterClick'  // Wrong casing
```

## Server-Side Tracking

### Page Load

```typescript
export const load: PageServerLoad = async (event) => {
  const startTime = Date.now();
  // ... data fetching ...
  
  const metadata = {
    total_events: eventsDetail.length,
    load_time_ms: Date.now() - startTime,
    has_events: eventsDetail.length > 0
  };

  await Promise.all([
    statsigService.logEvent('admin_jadwal_view', 'load', session || undefined, metadata),
    posthogService.trackEvent('admin_jadwal_view', { event_type: 'page_load', ...metadata }, session || undefined)
  ]);
};
```

### Error Tracking

```typescript
} catch (err) {
  const errorMetadata = {
    error_type: err instanceof Error ? err.name : 'unknown',
    error_message: err instanceof Error ? err.message : String(err)
  };
  
  await Promise.all([
    statsigService.logEvent('admin_jadwal_error', 'data_fetch_failed', session || undefined, errorMetadata),
    posthogService.trackEvent('admin_jadwal_error', { event_type: 'data_fetch_failed', ...errorMetadata }, session || undefined)
  ]);
  
  throw error(500, 'Failed to fetch data');
}
```

## Client-Side Tracking

### Imports

```typescript
import { statsigService } from '$src/lib/application/StatsigService.js';
import { tracker } from '$src/lib/utils/analytics';
```

### Filter Changes

```typescript
async function setFilter(filter: FilterStatus) {
  const metadata = {
    previous_filter: currentFilter,
    new_filter: filter,
    filtered_count: filteredEvents().length,
    total_count: upcomingEvents.length
  };

  statsigService.logEvent('admin_jadwal_filter', 'change', page.data.session || undefined, metadata);
  await tracker.track('admin_jadwal_filter_change', metadata, page.data.session, page);
}
```

### Event Navigation

```typescript
async function handleEventClick(eventId: string, progress: number) {
  await tracker.track('admin_jadwal_event_navigate', {
    event_id: eventId,
    progress_percentage: progress,
    progress_status: progress === 100 ? 'complete' : progress > 0 ? 'partial' : 'unconfirmed'
  }, page.data.session, page);
}
```

### Empty States

```typescript
$effect(() => {
  if (filteredEvents().length === 0 && upcomingEvents.length > 0) {
    tracker.track('admin_jadwal_empty_filter', {
      filter: currentFilter,
      total_events: upcomingEvents.length
    }, page.data.session, page);
  }
});
```

## PostHog Autocapture

PostHog automatically tracks: button clicks, link clicks, page views, form interactions.

**Do NOT manually track these.** Add business context when needed:

```typescript
// ✅ Good: Autocapture handles click, we add business metadata
async function handleEventClick(eventId: string, progress: number) {
  await tracker.track('admin_jadwal_event_navigate', {
    event_id: eventId,
    progress_percentage: progress
  }, page.data.session, page);
}

// ❌ Bad: Manually tracking basic clicks
async function handleButtonClick() {
  await tracker.track('button_clicked', { button: 'submit' }, page.data.session, page);
}
```

## Metadata Guidelines

- Use **snake_case** for metadata keys
- Always include rich context, not minimal data
- Include session context in all tracking calls

```typescript
// ✅ Good: Rich metadata
await tracker.track('admin_jadwal_filter_change', {
  previous_filter: previousFilter,
  new_filter: filter,
  filtered_count: filteredCount,
  total_count: upcomingEvents.length
}, page.data.session, page);

// ❌ Bad: Minimal metadata
await tracker.track('admin_jadwal_filter_change', {
  filter: filter
}, page.data.session, page);
```

## Reactive Tracking with Svelte 5

Use `$effect` for reactive tracking, not `onMount`:

```typescript
// ✅ Good: Reactive tracking
$effect(() => {
  if (filteredEvents().length === 0 && upcomingEvents.length > 0) {
    tracker.track('admin_jadwal_empty_filter', metadata, page.data.session, page);
  }
});

// ❌ Bad: Using onMount (only runs once)
onMount(() => {
  tracker.track('admin_jadwal_empty_filter', metadata, page.data.session, page);
});
```

## Best Practices

1. **Track business context, not basic interactions** (autocapture handles basic clicks)
2. **Use parallel execution** for dual tracking: `Promise.all([statsig, posthog])`
3. **Always include session context** in tracking calls
4. **Use type-safe error handling** when tracking errors
5. **Track empty states** for UX insights

## What NOT to Track

- ❌ Basic button clicks (autocapture)
- ❌ Basic link clicks (autocapture)
- ❌ Page views (layout handles)
- ❌ Form submissions (autocapture)

## What TO Track

- ✅ Filter changes with metadata
- ✅ Event navigation with progress context
- ✅ Empty states (UX insights)
- ✅ Server-side performance metrics
- ✅ Error conditions with context
- ✅ Custom business logic events
